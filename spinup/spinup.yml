#!/usr/local/src/ansible/bin/ansible-playbook
---
- name: Provision Rackspace DFW CentOS host on production network
  hosts: localhost
  connection: local
  gather_facts: False

  vars:
#   old: centos 6.5
    - image: 592c879e-f37d-43e6-8b54-8c2d97cf04d4
#   current image = centos 7
#    - image: f0d3b38b-61e3-47c4-83c7-98c4e7038809
    - credentials: /home/ansible/.rackspace_cloud_credentials

  vars_prompt:
    - name: "name"
      prompt: "hostname for new CentOS vm (e.g. db4)"
      private: no

    - name: "group"
      prompt: "group/role name (db, fep, other)"
      private: no
      default: "other"

    - name: "region"
      prompt: "region code (DFW, ORD ...)"
      private: no
      default: "DFW"

    - name: "auxnetwork"
      prompt: "private network name (production, engineering)"
      private: no
      default: "production"

    - name: "flavor"
      prompt: "machine flavor ID (default 2 = 512MB standard)"
      private: no
      default: "2"
     
      # see also: root password prompt in next play

  tasks:
    - name: Server create request
      local_action:
        module: rax
        state: present
        name: "{{ name }}"
        flavor: "{{ flavor }}"
        meta:
          group: "{{ group }}"
        image: "{{ image }}"
        region: "{{ region }}"
        creds_file: "{{ credentials }}"
        disk_config: manual
        networks:
          - public
          - private
          - "{{ auxnetwork }}"
        count: 1
        auto_increment: False
        wait: yes
        wait_timeout: 600
      register: rax

    - name: Add server to temporary group
      local_action:
        module: add_host
        hostname: "{{ item.name }}"
        ansible_ssh_host: "{{ item.rax_accessipv4 }}"
        ansible_ssh_pass: "{{ item.rax_adminpass }}"
        ansible_ssh_user: root
        groupname: tempservers
      with_items: rax.success
      when: rax.action == 'create'

- include: do_configure.yml
